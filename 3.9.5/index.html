<!DOCTYPE html>
<html lang="en-us">

  <head>
    <link href="https://gmpg.org/xfn/11" rel="profile" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  
    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  
    <title>
      
        Illumina DRAGEN on Azure &middot; DRAGEN on Azure
      
    </title>
  
    

  
    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="assets/css/icons.css" />
    

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" />
  
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />
  
    <!-- RSS -->
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />
  
    <!-- Additional head bits without overriding original head -->
  </head>
  

  <body class="page home">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
      </a>
      <span class="icon-dragen-text"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span><span class="path6"></span><span class="path7"></span><span class="path8"></span></span><br/>
    </div>
    <p class="lead">Quickstart</p>
  </header>
  <nav id="sidebar-nav-links">
  
  

  

  


  

  
    
  

  

  


  


  

  
    
  

  

  


  <div class="version-nav"></div>

<div class="sidebar-nav-list">
    
    <a href="#introduction">Introduction</a>
    <br />

    
    
    <a href="#architecture">Architecture</a>
    <br />

    
    
    <a href="#prerequisites">Prerequisites</a>
    <br />

    
    
    <a href="#deployment">Deployment</a>
    <br />

    
      <div class="sidebar-nav-list">
    
    <a href="#steps">Steps</a>
    <br />

    
    
    <a href="#additional-configurations">Additional Configurations</a>
    <br />

    
    
    <a href="#testing-using-the-azure-cli">Testing using the Azure CLI</a>
    <br />

    
    
</div>

    
    
    <a href="#troubleshooting">Troubleshooting</a>
    <br />

    
    
    <a href="#additional-resources">Additional Resources</a>
    <br />

    
    
    <a href="#contributing">Contributing</a>
    <br />

    
    
    <a href="#notices">Notices</a>
    <br />

    
    
    <a href="#privacy">Privacy</a>
    <br />

    
    
</div>


</nav>


  
</div>
<script>
  // Give some wiggle room at the top/bottom page
  // when triggering active sections
  let threshold;
  window.addEventListener('resize', function(){
    threshold = window.innerHeight / 3;
  });

  const navList = document.querySelectorAll('.sidebar-nav-list a');
  window.addEventListener('scroll', function() {
    let current = navList[0];

    navList.forEach(function(navItem){
      // Remove active class from all navItems
      navItem.classList.remove('active');

      const sectionItem = document.querySelector(navItem.getAttribute('href')),
            headerLocation = navItem.offsetTop;
      
      // If sectionItem is scrolled into view + threshold
      if (pageYOffset + threshold > sectionItem.offsetTop) {
        current = navItem;
      }        
    });

    if (pageYOffset + window.innerHeight + threshold < document.body.clientHeight) {
      // We are not at the bottom, mark current navItem active
      current.classList.add('active');
    } else {
      // We are at the bottom, assign active to last element
      // otherwise we would never mark active on the final navItem
      navList[navList.length-1].classList.add('active');
    }
  });

  document.addEventListener("DOMContentLoaded", function() {
    window.dispatchEvent(new Event('resize'));
    window.dispatchEvent(new Event('scroll'));
  });
</script>


    <main class="container">
      <header id="page-header">
  


  <h1 class="page-title">Illumina DRAGEN on Azure</h1>
</header>
<div class="content">
    <div class="mobile-header">
        <div class="logo">
          <span class="icon-dragen-text"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span><span class="path6"></span><span class="path7"></span><span class="path8"></span></span><br/>
          <span class="icon-plus spacer"></span>
          <span class="icon-ms-azure"><span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span><span class="path5"></span><span class="path6"></span><span class="path7"></span><span class="path8"></span><span class="path9"></span><span class="path10"></span><span class="path11"></span><span class="path12"></span></span>
        </div>
        <div class="version-nav"></div>
    </div>
  
<h2 id="introduction">Introduction</h2>

<p>This Quick Start guide provides instructions and resources to guide users through deploying <a href="https://www.illumina.com/products/by-type/informatics-products/dragen-bio-it-platform.html">Dynamic Read Analysis for GENomics (DRAGEN)</a> on Azure.  It is primarily intended for users who are interested in a quick and easy setup for running genomics workloads in the cloud.</p>

<p>This tutorial and its associated Marketplace solution in Azure were developed by Illumina in collaboration with Microsoft.  The reference deployment described below serves as a starting point, but can be further customized to meet your needs.</p>

<p>If you run into any issues while going through the tutorial, please <a href="#contributing">share your feedback with us</a>!</p>

<ul>
  <li><a href="mainTemplate.json">DRAGEN Infrastructure ARM Template</a></li>
</ul>

<p><br /></p>

<h2 id="architecture">Architecture</h2>

<h3 id="supported-regions">Supported Regions</h3>

<p>DRAGEN on Azure is available in regions where FPGA-enabled <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/np-series">Standard NP Family VMs</a> are available.  At the time of this writing, supported regions currently include:</p>

<ul>
  <li>West US 2</li>
  <li>East US</li>
  <li>Southeast Asia (Singapore)</li>
  <li>West Europe (Amsterdam)</li>
</ul>

<p>For the most current information on available regions, see the NP-series row of the chart <a href="https://azure.microsoft.com/en-us/global-infrastructure/services/?products=virtual-machines">here</a>.</p>

<h3 id="architecture-diagram">Architecture Diagram</h3>

<p><img src="./images/dragen-on-azure.png" alt="architecture-diagram" /></p>

<h3 id="resource-list">Resource List</h3>

<p>List of Azure resources that are deployed by this quickstart if default settings and parameters are used:</p>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview">Azure Blob Storage Account</a> for input and output data
    <ul>
      <li>Note: A new storage account is created by default, although users have the option to specify an existing storage account - see section on additional deployment configurations</li>
      <li><a href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-blobs-introduction#containers">Blob Storage Container</a></li>
    </ul>
  </li>
  <li><a href="https://docs.microsoft.com/en-us/azure/batch/batch-technical-overview">Azure Batch Account</a> for managing and scheduling DRAGEN jobs.
    <ul>
      <li>Provisioned in <a href="#user-subscription-node-pools">User Subscription Mode</a>.</li>
      <li><a href="https://docs.microsoft.com/en-us/azure/batch/nodes-and-pools">Node pool</a> backed by one <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/np-series">NP-series VM</a> (fixed scale).</li>
    </ul>
  </li>
  <li><a href="https://docs.microsoft.com/en-us/azure/key-vault/general/basic-concepts">Azure Key Vault</a> for batch service auth to User Subscription node pool VMs
    <ul>
      <li>Note: Batch service handles auth automatically, so users do not need to take any further action after the Key Vault is created.</li>
    </ul>
  </li>
</ul>

<h3 id="note-on-batch-node-pool-allocation">Note on Batch Node Pool Allocation</h3>

<p>Batch offers two options for allocation of node pools: Batch managed and user subscription modes. A single Batch Account can only support one node pool type at a time, meaning you cannot have batch managed and user subscription mode node pools under the same batch account.</p>

<h4 id="batch-managed-node-pools">Batch Managed Node Pools</h4>

<p>When Batch Managed allocation mode is selected, users must request NP VM quota for each specific Batch instance they create.  Nodes are allocated as needed from Batch-managed subscriptions.  This scenario works best when users intend to persist and use one or very few Batch instances for their DRAGEN jobs.  It is less ideal in situations where the creation/deletion of Batch accounts is automated or occurs frequently, as with CI/CD.</p>

<h4 id="user-subscription-node-pools">User Subscription Node Pools</h4>

<p>When the User Subscription allocation mode is selected, users request an overall quota for NP VMs for a region within their subscription.  With this model, the VMs needed for the Batch account are created directly in the user’s subscription.  This setup is useful for CI/CD and other cases where users are running DRAGEN across many Batch accounts within a subscription and/or the Batch accounts are short-lived.</p>

<h4 id="cost-differences-in-node-pool-allocation-modes">Cost Differences in Node Pool Allocation Modes</h4>

<p>There may be cost differences between the two different node pool allocation methods.  Consider your usage scenarios and consult Azure documentation and pricing calculators to determine which approach will be most optimal for your needs.</p>

<h3 id="azure-costs">Azure Costs</h3>

<p>Users are responsible for costs of any services deployed through this quickstart or its customization options.</p>

<p>Prices are subject to change - more information can be found on the pricing pages for Azure resources deployed through this tutorial:</p>

<ul>
  <li><a href="https://azure.microsoft.com/en-us/pricing/details/storage/blobs/">Azure Blob Storage</a></li>
  <li><a href="https://azure.microsoft.com/en-us/pricing/details/batch/windows-virtual-machines/">Azure Batch</a>
    <ul>
      <li><em>Note: There is currently no charge for Batch itself, only the compute resources it uses; see VM pricing below</em></li>
    </ul>
  </li>
  <li><a href="https://azure.microsoft.com/en-us/pricing/details/virtual-machines/linux/#np-series">Azure NP-series VMs</a> (a NP10s is used in this reference deployment)</li>
  <li><a href="https://azure.microsoft.com/en-us/pricing/details/key-vault/#pricing">Azure Key Vault</a></li>
</ul>

<p>Users are also responsible for costs of any licenses needed to run DRAGEN (not included in this quickstart - must be obtained separately).</p>

<h4 id="estimate-your-costs">Estimate your Costs</h4>

<p>For help in estimating your costs to run DRAGEN on Azure, see the pricing calculator located <a href="https://azure.microsoft.com/en-us/pricing/calculator/">here</a>.</p>

<p><br /></p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
  <li><strong>A DRAGEN License</strong> - To obtain a license, please contact Illumina at techsupport@illumina.com.</li>
  <li><strong>Access to DRAGEN Image via Azure Marketplace</strong> - If you would like to gain access, please contact Illumina at techsupport@illumina.com.</li>
</ul>

<h3 id="technical-requirements">Technical Requirements</h3>

<ul>
  <li><strong>Azure Subscription.</strong> An Azure Cloud Subscription.</li>
  <li><strong>Quota for NP-Series Virtual Machines.</strong> You will need to request a quota
for vCPU cores for the NP-series of virtual machines on Azure.</li>
  <li><strong>Azure CLI.</strong> You’ll need to <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">install</a> the Azure CLI.</li>
  <li><strong>Genomic Data.</strong> This quick start will create (if it does not already exist) an
Azure Blob Storage Account. You will need to upload your genomics data to this
storage account to utilize DRAGEN.</li>
</ul>

<h3 id="quota-requirements">Quota Requirements</h3>

<p>DRAGEN runs on a specific Virtual Machine SKU family in Azure, because it requires
<strong>field-programmable gate array</strong> (FPGA) hardware.  Due to this requirement, you
will need to request access to this Virtual Machine SKU family, as described below.</p>

<h4 id="np-series-vms">NP-Series VMs</h4>

<p>DRAGEN runs on FPGA-enabled VMs, which are now generally available as the <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/np-series">NP-series</a> on Azure.</p>

<blockquote>
  <p>Currently, the vCPU requirements for NP-series SKUs are in increments of 10. When requesting an updated quota, we recommend requesting vCPUs in batches of 10. You will need a minimum increase of 10 vCPU Quota for NP-series machines for this tutorial.</p>
</blockquote>

<p>For steps to increase or verify your NP-series vCPU quota on Azure, follow <a href="#login-to-your-azure-portal-account">this deployment step</a>.</p>

<h4 id="batch-accounts">Batch Accounts</h4>

<p>This quickstart will utilize <a href="https://azure.microsoft.com/en-us/services/batch/">Azure Batch</a> as the computing environment for DRAGEN, in <a href="https://docs.microsoft.com/en-us/azure/batch/scripts/batch-cli-sample-create-user-subscription-account">user subscription mode</a>.</p>

<p>It is also possible to run Azure Batch in <strong>Batch service allocation mode</strong>. In Batch service allocation mode, compute nodes are subject to a separate quota. For DRAGEN, in Batch service allocation mode, you will need to request additional quota for NP-series vCPUs for your discrete Azure Batch account. Current default quotas for Batch accounts can be found <a href="https://docs.microsoft.com/en-us/azure/batch/batch-quota-limit#resource-quotas">here</a>. You can increase your Azure Batch account quota by <a href="https://docs.microsoft.com/en-us/azure/batch/batch-quota-limit#increase-a-quota">following the steps here</a>.</p>

<h4 id="required-permissions-authorization--access-controls">Required Permissions (Authorization / Access Controls)</h4>

<p>To provision this solution, the Active Directory principal (account, service principal, etc.) should require at least Azure subscription-wide <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#contributor">contributor access</a>.</p>

<p>If your organization is concerned about this level of access, a deployment pipeline (e.g., GitHub Actions) running as a managed service principal with <strong><em>contributor</em></strong> access can allow others to have a more restricted privilege level (e.g., Resource Group Contributor, Subscription Reader).</p>

<p>When utilizing a User Subscription Mode Batch Account, the Azure Batch Service must be added to the Azure Subscription as a Contributor. To add this level of access, you must be at least a Subscription Contributor. For more information, see <a href="https://docs.microsoft.com/en-us/azure/batch/batch-account-create-portal#additional-configuration-for-user-subscription-mode">additional configuration for user subscription mode</a>.</p>

<p><br /></p>

<h2 id="deployment">Deployment</h2>

<h2 id="steps">Steps</h2>

<h3 id="login-to-your-azure-portal-account">Login to your Azure Portal account</h3>

<ol>
  <li>Log in to your Azure account in the <a href="https://portal.azure.com">Azure Portal</a>.</li>
  <li>
    <p>Ensure you have Quota for NP-series Virtual Machines, as outlined in the
pre-requisites section above, by navigating to:</p>

    <ul>
      <li>Subscriptions -&gt; Choose your subscription</li>
      <li>Click <strong>Usages + quotas</strong> from the left-side menu</li>
      <li>Filter the list by typing <strong>NP</strong> into the left search bar.
        <ul>
          <li>You should see <code class="language-plaintext highlighter-rouge">Standard NPS Family vCPUs</code>, and a denomination. If you see
<code class="language-plaintext highlighter-rouge">0 of 0</code>, click the edit icon to request quota.</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h3 id="deploy-the-quickstart-solution-template">Deploy the Quickstart (solution template)</h3>

<ol>
  <li>While signed in to your Azure account, open the page for the DRAGEN Solution:
    <ol>
      <li>Navigate to the <a href="https://ms.portal.azure.com/#blade/Microsoft_Azure_Marketplace/GalleryMenuBlade/selectedMenuItemId/home">Marketplace</a></li>
      <li>Search for “DRAGEN” and select DRAGEN Bio-IT Platform for Genomic Data Analysis on Azure Batch</li>
    </ol>
  </li>
  <li>If prompted, review the terms and conditions and then choose <strong>Accept Terms</strong></li>
  <li>Click <strong>Create</strong></li>
  <li>
    <p>You’ll be prompted to select a resource group and other particulars of the solution to deploy</p>

    <p><strong>NOTE:</strong> For storage settings, the “Premium” type SKUs are not currently supported by this offering</p>
  </li>
  <li>Once you’ve made your selections, click <strong>Review + Create</strong>
at the bottom of the screen and click <strong>Create</strong></li>
  <li>You can check deployment status in the top right of the Azure Portal page
<img src="./images/deployment-status.png" alt="deployment-status" /></li>
</ol>

<p><br /></p>

<h2 id="additional-configurations">Additional Configurations</h2>

<h3 id="advanced-usage-arm-template">Advanced Usage: ARM Template</h3>

<p>Incorporating DRAGEN on Azure into an existing solution may be as easy as using the <a href="mainTemplate.json">ARM template</a> that is exported alongside this documentation.</p>

<h4 id="usage-scenarios">Usage Scenarios</h4>

<p>Deployment using the ARM template enables several more advanced scenarios, such as:</p>

<ul>
  <li>Incorporation of infrastructure components needed for DRAGEN into an existing infrastructure</li>
  <li>Automated deployments via CI/CD pipelines</li>
  <li>Customization of the deployment to meet your needs</li>
</ul>

<h4 id="prerequisites-for-arm-template-deployment">Prerequisites for ARM Template Deployment</h4>

<p>Before attempting to deploy to your subscription via the ARM template, ensure that you have completed all of the <a href="#prerequisites">prerequisites</a> for running DRAGEN on Azure.</p>

<h4 id="parameters">Parameters</h4>

<p>The ARM template takes the following input parameters:</p>

<h5 id="required-parameters-no-default-value-set">Required parameters (no default value set)</h5>

<table>
  <thead>
    <tr>
      <th>Parameter Name</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">prefix</code></td>
      <td>Prefix for resource names (1-17 alphanumeric characters)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">azureBatchServiceOid</code></td>
      <td>Object ID for Azure Batch on the user’s tenant (Can be found by running the command <code class="language-plaintext highlighter-rouge">az ad sp show --id ddbf3205-c6bd-46ae-8127-60eb93363864 --query objectId</code>)</td>
    </tr>
  </tbody>
</table>

<h5 id="optional-parameters-default-values-are-set-but-can-be-overridden">Optional parameters (default values are set but can be overridden)</h5>

<table>
  <thead>
    <tr>
      <th>Parameter Name</th>
      <th>Default Value</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">location</code></td>
      <td>Resource group location</td>
      <td>Azure Region where resources should be deployed</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">storageAccountName</code></td>
      <td><code class="language-plaintext highlighter-rouge">prefix</code> + “storage”</td>
      <td>Name for Azure Blob Storage account (Total of 3-24 alphanumeric characters including prefix)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">storageSku</code></td>
      <td>Standard_LRS*</td>
      <td><a href="https://docs.microsoft.com/en-us/rest/api/storagerp/srp_sku_types">Azure Storage SKU</a></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">storageNewOrExisting</code></td>
      <td>new</td>
      <td>Specify whether to use an existing storage account or create a new one (Allowed values: <code class="language-plaintext highlighter-rouge">new</code> or <code class="language-plaintext highlighter-rouge">existing</code>)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">offerSku</code></td>
      <td>dragen-3-9</td>
      <td>SKU for the DRAGEN offer in the Marketplace</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">vmImageVersion</code></td>
      <td>3.9.5</td>
      <td>DRAGEN version</td>
    </tr>
  </tbody>
</table>

<p><strong>*NOTE:</strong> The “Premium” type SKUs are not currently supported by this offering.</p>

<h4 id="sample-arm-template-deployment">Sample ARM Template Deployment</h4>

<p>The following sample deploys the ARM template into a resource group using the Azure CLI <a href="https://docs.microsoft.com/en-us/cli/azure/deployment/group?view=azure-cli-latest#az_deployment_group_create">deployment group create</a> command:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Set variables for command inputs</span>
<span class="nv">RESOURCE_GROUP_NAME</span><span class="o">=</span><span class="s2">"dragen-rg"</span>
<span class="nv">LOCATION</span><span class="o">=</span><span class="s2">"EastUS"</span>
<span class="nv">PREFIX</span><span class="o">=</span><span class="s2">"dragen"</span>
<span class="nv">BATCH_OID</span><span class="o">=</span>&lt;Batch Object Id <span class="k">for </span>your tenant - see Parameters section&gt;

<span class="c"># Create a resource group</span>
az group create <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$RESOURCE_GROUP_NAME</span><span class="s2">"</span> <span class="nt">-l</span> <span class="s2">"</span><span class="nv">$LOCATION</span><span class="s2">"</span>

<span class="c"># Deploy the ARM template</span>
az deployment group create <span class="se">\</span>
    <span class="nt">-g</span> <span class="s2">"</span><span class="nv">$RESOURCE_GROUP_NAME</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-p</span> <span class="nv">prefix</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PREFIX</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-p</span> <span class="nv">azureBatchServiceOid</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BATCH_OID</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-f</span> mainTemplate.json <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"properties.outputs"</span>
</code></pre></div></div>

<h4 id="using-a-new-vs-existing-storage-account">Using a New vs. Existing Storage Account</h4>

<p>By default, the ARM template included with this quickstart creates a new storage account and container.  Some users may already have data uploaded to an existing Azure Blob Storage account.  To use existing storage, specify the following input parameters to the ARM template in your deployment:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">storageNewOrExisting: existing</code></li>
  <li><code class="language-plaintext highlighter-rouge">storageAccountName: &lt;name of your existing storage account&gt;</code></li>
</ul>

<h3 id="batch-job--task-timeout">Batch Job &amp; Task Timeout</h3>

<p>It is possible to set a max run time on either the batch job or batch task.</p>

<p>The below command will terminate the batch job as well as all tasks within
it after the job has been present for 360 minutes.</p>

<ul>
  <li>JOB_ID: The job id of the already created job.</li>
  <li>PT360M: An ISO-8601 duration, PT360M = 360 minutes.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az batch job <span class="nb">set</span> <span class="se">\</span>
    <span class="nt">--job-id</span> <span class="nv">$JOB_ID</span> <span class="se">\</span>
    <span class="nt">--on-all-tasks-complete</span> <span class="s2">"terminatejob"</span> <span class="se">\</span>
    <span class="nt">--job-max-wall-clock-time</span> <span class="s2">"PT360M"</span>
</code></pre></div></div>

<p>If you would like to set a max run time on the batch task instead, you can add
the following section to the task.json:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"constraints"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"maxWallClockTime"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PT360M"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="other-deployment-considerations">Other Deployment Considerations</h3>

<p>After deploying DRAGEN on Azure, users will want to take into account the following additional deployment considerations and options, which are <em>not</em> included as part of this quickstart template:</p>

<ul>
  <li>Compliance</li>
  <li>Authentication</li>
  <li>Security</li>
  <li>Monitoring and Observability</li>
</ul>

<p>Decisions regarding implementation of any of the above are left to the end user’s discretion.</p>

<p><br /></p>

<h2 id="testing-using-the-azure-cli">Testing using the Azure CLI</h2>

<p>Once your batch account infrastructure has been created, the following guide
can be used to create batch jobs and tasks.  This guide makes use of the
Azure CLI.</p>

<h3 id="azure-cli-authentication">Azure CLI Authentication</h3>

<p>The first step is to make sure you are
<a href="https://docs.microsoft.com/en-us/cli/azure/authenticate-azure-cli">authenticated</a>
through <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a>,
and using the subscription in which your batch account has been provisioned.</p>

<h3 id="batch-account-login">Batch Account Login</h3>

<p>You will need to authenticate with the provisioned batch account in order to
create jobs and tasks.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az batch account login <span class="nt">-n</span> &lt;batch account name&gt; <span class="nt">-g</span> &lt;resource group name&gt;
</code></pre></div></div>

<h3 id="create-batch-job">Create Batch Job</h3>

<p>Once authenticated, the next step is to create a batch job using the following variables:</p>

<ul>
  <li>JOB_ID: A unique id to assign to the job being created.</li>
  <li>POOL_ID: The name of the pool created with the provided ARM template.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az batch job create <span class="nt">--id</span> &lt;JOB_ID&gt; <span class="nt">--pool-id</span> &lt;POOL_ID&gt;
</code></pre></div></div>

<h3 id="create-batch-task">Create Batch Task</h3>

<p>Once the batch job has been created, a task can be added to it.  This can be done using the JOB_ID and
a task.json specification file:</p>

<ul>
  <li>JOB_ID: The same job id used when creating the batch job.</li>
  <li>JSON_FILE: A file that defines a task in JSON format.</li>
</ul>

<h4 id="batch-command">Batch Command</h4>

<p>The command passed to the batch task is what will run once the batch task
starts.  The following is an example that will run a series of commands
using bash.</p>

<p>This example takes advantage of bash to execute commands, as well as make sure that
<a href="https://docs.microsoft.com/en-us/azure/batch/batch-compute-node-environment-variables#environment-variable-visibility">environment variables</a>
are available.  The following are example environment variables and bash command:</p>

<ul>
  <li>REF_DIR: The directory to untar the genome hash table to.</li>
  <li>OUT_DIR: The directory to write the DRAGEN results to.</li>
  <li>FQ1: The path to the first local FASTQ file on the node.</li>
  <li>FQ2: The path to the second local FASTQ file on the node.</li>
  <li>RGID: The RGID associated with this DRAGEN run.</li>
  <li>RGSM: THE RGSM associated with this DRAGEN run.</li>
  <li>OUTPUT_PREFIX: The prefix that will be used for the DRAGEN output files.</li>
  <li>LICENSE: The DRAGEN license.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/bin/bash <span class="nt">-c</span> <span class="se">\</span>
<span class="s2">"mkdir &lt;REF_DIR&gt; &lt;OUT_DIR&gt;; </span><span class="se">\</span><span class="s2">
tar xzvf dragen.tar -C &lt;REF_DIR&gt;; </span><span class="se">\</span><span class="s2">
/opt/edico/bin/dragen --partial-reconfig HMM --ignore-version-check true; </span><span class="se">\</span><span class="s2">
/opt/edico/bin/dragen -f -r &lt;REF_DIR&gt; </span><span class="se">\</span><span class="s2">
    -1 &lt;FQ1&gt; </span><span class="se">\</span><span class="s2">
    -2 &lt;FQ2&gt; </span><span class="se">\</span><span class="s2">
    --RGID &lt;RGID&gt; </span><span class="se">\</span><span class="s2">
    --RGSM &lt;RGSM&gt; </span><span class="se">\</span><span class="s2">
    --enable-bam-indexing true </span><span class="se">\</span><span class="s2">
    --enable-map-align-output true </span><span class="se">\</span><span class="s2">
    --enable-sort true </span><span class="se">\</span><span class="s2">
    --output-file-prefix &lt;OUTPUT_PREFIX&gt; </span><span class="se">\</span><span class="s2">
    --enable-map-align true </span><span class="se">\</span><span class="s2">
    --output-format BAM </span><span class="se">\</span><span class="s2">
    --output-directory &lt;OUT_DIR&gt; </span><span class="se">\</span><span class="s2">
    --enable-variant-caller true </span><span class="se">\</span><span class="s2">
    --lic-server &lt;LICENSE&gt;"</span>
</code></pre></div></div>

<h4 id="sas">SAS</h4>

<p>The following example will generate a full URL with SAS token to access a
file in a private blob storage account.  This is useful when wanting to
obtain read access to a specific file in a protected storage account.</p>

<ul>
  <li>BLOB_PATH: The path to the file within the container.</li>
  <li>STORAGE_ACCOUNT: The name of the blob storage account.</li>
  <li>STORAGE_ACCOUNT_KEY: An access key to the storage account.</li>
  <li>EXPIRE_DATE: The datetime when the SAS token should expire.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az storage blob generate-sas <span class="se">\</span>
    <span class="nt">--name</span> &lt;BLOB_PATH&gt; <span class="se">\</span>
    <span class="nt">--account-name</span> &lt;STORAGE_ACCOUNT&gt; <span class="se">\</span>
    <span class="nt">--account-key</span> &lt;STORAGE_ACCOUNT_KEY&gt; <span class="se">\</span>
    <span class="nt">--container-name</span> &lt;CONTAINER_NAME&gt; <span class="se">\</span>
    <span class="nt">--expiry</span> &lt;EXPIRE_DATE&gt; <span class="se">\</span>
    <span class="nt">--permissions</span> r <span class="se">\</span>
    <span class="nt">--https</span> <span class="se">\</span>
    <span class="nt">--full-uri</span> <span class="se">\</span>
    <span class="nt">--output</span> tsv
</code></pre></div></div>

<p>If obtaining write access to a container within a storage account is
necessary, a slightly different command can be used.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az storage container generate-sas <span class="se">\</span>
    <span class="nt">--name</span> &lt;CONTAINER_NAME&gt; <span class="se">\</span>
    <span class="nt">--account-name</span> &lt;STORAGE_ACCOUNT&gt; <span class="se">\</span>
    <span class="nt">--expiry</span> &lt;EXPIRE_DATE&gt; <span class="se">\</span>
    <span class="nt">--permissions</span> aclrw <span class="se">\</span>
    <span class="nt">--https-only</span> <span class="se">\</span>
    <span class="nt">--output</span> tsv
</code></pre></div></div>

<p>In this case, the SAS token returned by the command will need to be
appended to the container URL, for example:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CONTAINER_URL</span><span class="o">=</span><span class="s2">"https://&lt;STORAGE_ACCOUNT&gt;.blob.core.windows.net/&lt;CONTAINER&gt;?&lt;SAS_TOKEN&gt;
</span></code></pre></div></div>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/cli/azure/storage/blob?view=azure-cli-latest#az_storage_blob_generate_sas">SAS CLI Reference</a></li>
</ul>

<h4 id="resource-files">Resource Files</h4>

<p>In this example, both the genome file and the FASTQ files need to be on the
batch node when running the batch command.  This script takes advantage of the
<code class="language-plaintext highlighter-rouge">resourceFiles</code> configuration to facilitate this.</p>

<p>If the genome tarball and FASTQ files are in a private blob storage account, a
<a href="#sas">SAS token</a> will need to be generated to allow batch to download the file.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"resourceFiles"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dragen.tar"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"httpUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$GENOME_URL"</span><span class="w">
</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.fq.gz"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"httpUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$FQ1_URL"</span><span class="w">
</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.fq.gz"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"httpUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$FQ2_URL"</span><span class="w">
</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/azure/batch/resource-files#single-resource-file-from-web-endpoint">Resource Files Reference</a></li>
</ul>

<h4 id="output-files">Output Files</h4>

<p>Output files configuration tells batch tasks to write certain files to external
locations, triggered by certain events.  We will use this feature in this example
to get various logs and DRAGEN output out to our storage container at the end
of the run.</p>

<ul>
  <li>CONTAINER_URL: The container url generated above with the SAS token appended to it.</li>
  <li>TASK_ID: A task id, used in this case to organize the output.</li>
  <li>OUT_DIR: The directory the DRAGEN results were written to.</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"outputFiles"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../stdout.txt"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;CONTAINER_URL&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;TASK_ID&gt;/stdout.txt"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../stderr.txt"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;CONTAINER_URL&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;TASK_ID&gt;/stderr.txt"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;OUT_DIR&gt;/**/*"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;CONTAINER_URL&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;TASK_ID&gt;/&lt;OUT_DIR&gt;"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/log/dragen.log"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;CONTAINER_URL&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;TASK_ID&gt;/log/dragen.log"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/log/dragen/**/*"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;CONTAINER_URL&gt;"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;TASK_ID&gt;/log/dragen"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<h4 id="taskjson">task.json</h4>

<p>The overall structure of the task.json will look like the following,
with each of the sections described in detail above.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;TASK_ID&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"commandLine"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;COMMAND&gt;"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"resourcesFiles"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&lt;RESOURCE_FILES&gt;</span><span class="p">],</span><span class="w">
    </span><span class="nl">"outputFiles"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">&lt;OUTPUT_FILES&gt;</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="create-task">Create Task</h4>

<p>With the command generated to run within the task, and accessible URLs
generated for the genome tarball and FASTQ files, the following command
can be used to create the batch task:</p>

<p>The following URLs must either be public, or private but made accessible
(for example, with a SAS token):</p>

<ul>
  <li>GENOME_URL: URL of a genome tarball.</li>
  <li>FQ1_URL: URL of the first FASTQ file.</li>
  <li>FQ2_URL: URL of the second FASTQ file.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az batch task create <span class="se">\</span>
    <span class="nt">--job-id</span> &lt;JOB_ID&gt; <span class="se">\</span>
    <span class="nt">--json-file</span> task.json
</code></pre></div></div>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/cli/azure/batch/task?view=azure-cli-latest#az_batch_task_create">Batch task create CLI reference</a></li>
</ul>

<h4 id="working-example">Working Example</h4>

<h5 id="batch-job-create">Batch Job Create</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az batch job create <span class="nt">--id</span> job1 <span class="nt">--pool-id</span> mypool
</code></pre></div></div>

<h5 id="create-command">Create <code class="language-plaintext highlighter-rouge">$COMMAND</code></h5>

<p>The following command line string is assigned to the <code class="language-plaintext highlighter-rouge">$COMMAND</code> variable.</p>

<h5 id="command-variable"><code class="language-plaintext highlighter-rouge">$COMMAND</code> Variable</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">COMMAND</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">

/bin/bash -c </span><span class="se">\</span><span class="sh">
"mkdir dragen output; </span><span class="se">\</span><span class="sh">
tar xzvf dragen.tar -C dragen; </span><span class="se">\</span><span class="sh">
/opt/edico/bin/dragen --partial-reconfig HMM --ignore-version-check true; </span><span class="se">\</span><span class="sh">
/opt/edico/bin/dragen -f -r dragen </span><span class="se">\</span><span class="sh">
    -1 1.fq.gz </span><span class="se">\</span><span class="sh">
    -2 2.fq.gz </span><span class="se">\</span><span class="sh">
    --RGID NA24385-AJ-Son-R1-NS_S33.1 </span><span class="se">\</span><span class="sh">
    --RGSM NA24385-AJ-Son-R1-NS_S33 </span><span class="se">\</span><span class="sh">
    --enable-bam-indexing true </span><span class="se">\</span><span class="sh">
    --enable-map-align-output true </span><span class="se">\</span><span class="sh">
    --enable-sort true </span><span class="se">\</span><span class="sh">
    --output-file-prefix NA24385-AJ-Son-R1-NS_S33 </span><span class="se">\</span><span class="sh">
    --enable-map-align true </span><span class="se">\</span><span class="sh">
    --output-format BAM </span><span class="se">\</span><span class="sh">
    --output-directory output </span><span class="se">\</span><span class="sh">
    --enable-variant-caller true </span><span class="se">\</span><span class="sh">
    --lic-server &lt;LICENSE&gt;"
</span><span class="no">
EOF
</span><span class="si">)</span>
</code></pre></div></div>

<p>This one-liner achieves the following:</p>

<ol>
  <li>Sets up Genome and Output directories</li>
  <li>Unarchives the genome file</li>
  <li>Runs a partial reconfig on the FPGA</li>
  <li>Runs DRAGEN</li>
</ol>

<p>The <code class="language-plaintext highlighter-rouge">$COMMAND</code> variable is now interpolated in the <code class="language-plaintext highlighter-rouge">task.json</code> file below.</p>

<h5 id="create-taskjson">Create task.json</h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"task1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"commandLine"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$COMMAND"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"resourceFiles"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
        </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dragen.tar"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"httpUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://dragentestdata.blob.core.windows.net/reference-genomes/Hsapiens/hash-tables/hg38_altaware_nohla-cnv-anchored.v8.tar"</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.fq.gz"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"httpUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://dragentestdata.blob.core.windows.net/samples/wes/NA24385-AJ-Son-R1-NS_S33/NA24385-AJ-Son-R1-NS_S33_L001_R1_001.fastq.gz"</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.fq.gz"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"httpUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://dragentestdata.blob.core.windows.net/samples/wes/NA24385-AJ-Son-R1-NS_S33/NA24385-AJ-Son-R1-NS_S33_L001_R2_001.fastq.gz"</span><span class="w">
    </span><span class="p">}],</span><span class="w">
    </span><span class="nl">"outputFiles"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
        </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../stdout.txt"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$CONTAINER_URL"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"task1/stdout.txt"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../stderr.txt"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$CONTAINER_URL"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"task1/stderr.txt"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"output/**/*"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$CONTAINER_URL"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"task1/output"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/log/dragen.log"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$CONTAINER_URL"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"task1/log/dragen.log"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"filePattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/var/log/dragen/**/*"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"container"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"containerUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;CONTAINER_URL&gt;"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"task1/log/dragen"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"uploadOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"uploadCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"taskcompletion"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="batch-task-create">Batch Task Create</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>az batch task create <span class="se">\</span>
    <span class="nt">--job-id</span> job1 <span class="se">\</span>
    <span class="nt">--json-file</span> task.json
</code></pre></div></div>

<h4 id="file-streaming">File Streaming</h4>

<p>While it is always necessary to have the genome file locally on the node, DRAGEN
can stream input FASTQ files and BAMs from private Azure Blob containers for faster
processing.  DRAGEN does not currently support streaming from public Blob containers.</p>

<h5 id="stream-from-azure-blob-storage">Stream from Azure Blob Storage</h5>

<p>The following parameters are needed for streaming from Blob storage:</p>

<ul>
  <li>STORAGE_ACCOUNT_NAME: The name of the blob storage account.</li>
  <li>STORAGE_ACCOUNT_KEY: An access key to the storage account.</li>
  <li>FQ1_URL: The full URL to the first FASTQ file in Azure Blob Storage.</li>
  <li>FQ2_URL: The full URL to the second FASTQ file in Azure Blob Storage.</li>
</ul>

<h5 id="command-variable-for-streaming-fastq-inputs"><code class="language-plaintext highlighter-rouge">$COMMAND</code> Variable for Streaming FASTQ Inputs</h5>

<p>The following is an example <code class="language-plaintext highlighter-rouge">$COMMAND</code> variable that streams FASTQ inputs from Blob storage:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">COMMAND</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">

/bin/bash -c </span><span class="se">\</span><span class="sh">
"echo DefaultEndpointsProtocol=https &gt;&gt; ~/.azure-credentials; </span><span class="se">\</span><span class="sh">
echo AccountName=&lt;STORAGE_ACCOUNT_NAME&gt; &gt;&gt; ~/.azure-credentials; </span><span class="se">\</span><span class="sh">
echo AccountKey=&lt;STORAGE_ACCOUNT_KEY&gt; &gt;&gt; ~/.azure-credentials; </span><span class="se">\</span><span class="sh">
echo EndpointSuffix=core.windows.net &gt;&gt; ~/.azure-credentials; </span><span class="se">\</span><span class="sh">
mkdir dragen output; </span><span class="se">\</span><span class="sh">
tar xzvf dragen.tar -C dragen; </span><span class="se">\</span><span class="sh">
/opt/edico/bin/dragen --partial-reconfig HMM --ignore-version-check true; </span><span class="se">\</span><span class="sh">
/opt/edico/bin/dragen -f -r dragen </span><span class="se">\</span><span class="sh">
    -1 &lt;FQ1_URL&gt; </span><span class="se">\</span><span class="sh">
    -2 &lt;FQ2_URL&gt; </span><span class="se">\</span><span class="sh">
    --RGID &lt;RGID&gt; </span><span class="se">\</span><span class="sh">
    --RGSM &lt;RGSM&gt; </span><span class="se">\</span><span class="sh">
    --enable-bam-indexing true </span><span class="se">\</span><span class="sh">
    --enable-map-align-output true </span><span class="se">\</span><span class="sh">
    --enable-sort true </span><span class="se">\</span><span class="sh">
    --output-file-prefix &lt;OUTPUT_PREFIX&gt; </span><span class="se">\</span><span class="sh">
    --enable-map-align true </span><span class="se">\</span><span class="sh">
    --output-format BAM </span><span class="se">\</span><span class="sh">
    --output-directory output </span><span class="se">\</span><span class="sh">
    --enable-variant-caller true </span><span class="se">\</span><span class="sh">
    --lic-server &lt;LICENSE&gt;"
</span><span class="no">
EOF
</span><span class="si">)</span>
</code></pre></div></div>

<p>This one-liner achieves the same as the <code class="language-plaintext highlighter-rouge">$COMMAND</code> <a href="#command-variable">before</a>
with the addition of creating a <code class="language-plaintext highlighter-rouge">.azure-credentials</code> file containing key-value
pairs of Storage Account credentials.</p>

<p>In this case, the FASTQ files will no longer need to be referenced in the
resourceFiles in the task.json</p>

<h5 id="fastq-list">FASTQ List</h5>

<p>If using a FASTQ list file to reference and stream FASTQ files, the FASTQ list file must
also be local to the node.  The FASTQ files referenced in the FASTQ list can be URLs
to files on an Azure Storage Account, in which case, the FASTQs will be streamed by DRAGEN.</p>

<p>The following is an example of streaming inputs with a FASTQ list using the
resourceFiles configuration as well as a SAS token to access the file in Azure Blob Storage.
This is stored as the <a href="#list_url-for-streaming"><code class="language-plaintext highlighter-rouge">$LIST_URL</code></a> variable.</p>

<p>Since we are streaming from Azure Blob Storage, we will once again need the <code class="language-plaintext highlighter-rouge">~/.azure-credentials</code> file.</p>

<h5 id="list_url-for-streaming"><code class="language-plaintext highlighter-rouge">$LIST_URL</code> for Streaming</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">LIST_URL</span><span class="o">=</span><span class="si">$(</span>az storage blob generate-sas <span class="se">\</span>
    <span class="nt">--name</span> &lt;FASTQ_LIST_BLOB_PATH&gt; <span class="se">\</span>
    <span class="nt">--account-name</span> &lt;STORAGE_ACCOUNT&gt; <span class="se">\</span>
    <span class="nt">--account-key</span> &lt;STORAGE_ACCOUNT_KEY&gt; <span class="se">\</span>
    <span class="nt">--container-name</span> &lt;CONTAINER_NAME&gt; <span class="se">\</span>
    <span class="nt">--expiry</span> &lt;EXPIRE_DATE&gt; <span class="se">\</span>
    <span class="nt">--permissions</span> r <span class="se">\</span>
    <span class="nt">--https</span> <span class="se">\</span>
    <span class="nt">--full-uri</span> <span class="se">\</span>
    <span class="nt">--output</span> tsv<span class="si">)</span>
</code></pre></div></div>

<h5 id="command-variable-for-streaming-with-fastq-list"><code class="language-plaintext highlighter-rouge">$COMMAND</code> Variable for Streaming with FASTQ List</h5>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">COMMAND</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">

/bin/bash -c </span><span class="se">\</span><span class="sh">
"echo DefaultEndpointsProtocol=https &gt;&gt; ~/.azure-credentials; </span><span class="se">\</span><span class="sh">
echo AccountName=&lt;STORAGE_ACCOUNT_NAME&gt; &gt;&gt; ~/.azure-credentials; </span><span class="se">\</span><span class="sh">
echo AccountKey=&lt;STORAGE_ACCOUNT_KEY&gt; &gt;&gt; ~/.azure-credentials; </span><span class="se">\</span><span class="sh">
echo EndpointSuffix=core.windows.net &gt;&gt; ~/.azure-credentials; </span><span class="se">\</span><span class="sh">
mkdir dragen output; </span><span class="se">\</span><span class="sh">
tar xvf dragen.tar -C dragen; </span><span class="se">\</span><span class="sh">
/opt/edico/bin/dragen --partial-reconfig HMM --ignore-version-check true; </span><span class="se">\</span><span class="sh">
/opt/edico/bin/dragen -f -r dragen </span><span class="se">\</span><span class="sh">
    --fastq-list fastq_list.csv </span><span class="se">\</span><span class="sh">
    --fastq-list-sample-id &lt;RGSM&gt; </span><span class="se">\</span><span class="sh">
    --enable-bam-indexing true </span><span class="se">\</span><span class="sh">
    --enable-map-align-output true </span><span class="se">\</span><span class="sh">
    --enable-sort true </span><span class="se">\</span><span class="sh">
    --output-file-prefix &lt;OUTPUT_PREFIX&gt; </span><span class="se">\</span><span class="sh">
    --enable-map-align true </span><span class="se">\</span><span class="sh">
    --output-format BAM </span><span class="se">\</span><span class="sh">
    --output-directory output </span><span class="se">\</span><span class="sh">
    --enable-variant-caller true </span><span class="se">\</span><span class="sh">
    --lic-server &lt;LICENSE&gt;"
</span><span class="no">
EOF
</span><span class="si">)</span>
</code></pre></div></div>

<h5 id="taskjson-resourcefiles">task.json resourceFiles</h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"resourceFiles"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dragen.tar"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"httpUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$GENOME_URL"</span><span class="w">
</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"filePath"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fastq_list.csv"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"httpUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$LIST_URL"</span><span class="w">
</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<h5 id="example-bash-script">Example Bash Script</h5>

<p>An <a href="./create-batch-task.sh">example bash script</a> using the above commands is available for reference.
There is a required <code class="language-plaintext highlighter-rouge">LICENSE_URL</code> environment variable, as well as some variables within the script
that must be set before running it, ie:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">LICENSE_URL</span><span class="o">=</span>https://&lt;username&gt;:&lt;password&gt;@license.edico.com ./create-batch-task.sh
</code></pre></div></div>

<p>There are accompanying comments within the bash script to help set these.</p>

<p><br /></p>

<p><br /></p>

<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="arm-deployment">ARM Deployment</h3>

<p>If you are running into issues getting the infrastructure spun up through the
ARM template, there are a few options for debugging:</p>

<ol>
  <li>
    <p>If the resource group was created, navigate to the resource group, and
then the deployments menu option.  Here you will find the list of deployments
tied to this resource group, and navigating deeper into each deployment
may show additional information for the deployment of each resource.</p>
  </li>
  <li>
    <p>Open the <a href="https://ms.portal.azure.com/#blade/Microsoft_Azure_ActivityLog/ActivityLogBlade">Activity Log</a>
for an additional source of information for recent issues within your subscription.</p>
  </li>
</ol>

<h3 id="batch-tasks">Batch Tasks</h3>

<p>If you are running into issues getting your batch task to run successfully,
the best place to get information to help debug the problem is within the
<code class="language-plaintext highlighter-rouge">stdout</code> and <code class="language-plaintext highlighter-rouge">stderr</code> of the batch task itself.  This can be accessed by navigating
to your batch account in the portal, and then to the specific job and task
that ran.  Once there, you will be able to access <code class="language-plaintext highlighter-rouge">stdout.txt</code> and <code class="language-plaintext highlighter-rouge">stderr.txt</code>:</p>

<p><img src="./images/batch-task-file-list.png" alt="batch-task-file-list" /></p>

<h3 id="dragen-issues">DRAGEN Issues</h3>

<p>For failed DRAGEN runs, navigate to the batch account in the portal, then job and task associated with the failed run
to view DRAGEN log files.</p>

<h3 id="common-issues">Common Issues</h3>

<ol>
  <li>
    <p>Quota issues:  If quota increases haven’t been requested, it can be common
to run into quota issues for both the number of batch accounts as well as for
the <code class="language-plaintext highlighter-rouge">Standard NPS Family vCPUs</code>.  Please make sure you have available
<a href="#deployment-steps">quota</a> before deploying the ARM template.</p>
  </li>
  <li>
    <p>Input file streaming:  Currently, DRAGEN does not support input streaming
from public Blob containers.  Input files from private Blob containers can be
streamed provided that the proper storage credentials are passed to the batch
command.</p>
  </li>
  <li>
    <p>Command lines: Ensure that variables supplied to Azure CLI commands (e.g., account keys, license URLs, names of
resource groups, batch accounts, storage accounts and containers, batch pools, etc.) are correct.  Ensure that DRAGEN
command lines are formed properly and that the correct variables are passed to it.</p>
  </li>
  <li>
    <p>Task JSON:  Ensure that keys and values supplied to the json task file are correct and complete.  Ensure that the
file adheres to JSON formatting rules.</p>
  </li>
  <li>
    <p>Authentication:  Ensure that the Azure CLI is authenticated for use with the proper subscription prior to creating
resource groups and deploying ARM templates.  Log in to the proper Azure batch account prior to creating
batch jobs and tasks.  Provide the required authentication (e.g., SAS tokens) for private storage accounts and/or
input files, as needed.  Ensure that sufficient expiration periods are specified when generating authentication tokens.</p>
  </li>
</ol>

<p><br /></p>

<h2 id="additional-resources">Additional Resources</h2>

<ul>
  <li><a href="mainTemplate.json">DRAGEN Infrastructure ARM Template</a></li>
  <li><a href="https://support.illumina.com/downloads/illumina-dragen-bio-it-platform-user-guide.html">DRAGEN User Guide</a></li>
</ul>

<p><br /></p>

<h2 id="contributing">Contributing</h2>

<p>Contributions are welcome!</p>

<p><a href="https://github.com/Illumina/dragen-azure-quickstart">https://github.com/Illumina/dragen-azure-quickstart</a></p>

<p>As the documentation within the above repository is not directly managed through the repository, please do not submit pull requests.</p>

<h3 id="how-to-contribute">How to contribute</h3>

<p>When you have an idea for contribution, or want to report a bug or issue, please open an <a href="https://github.com/Illumina/dragen-azure-quickstart/issues"><em>issue</em></a>!</p>

<h3 id="feedback">Feedback</h3>

<p>Please open a <a href="https://github.com/Illumina/dragen-azure-quickstart/issues"><em>issue</em></a> if you would like to provide any feedback on the contents of this repository.</p>

<p><br /></p>

<h2 id="notices">Notices</h2>

<p>This document is provided for informational purposes only. It represents Azure’s current product offerings and practices as of the date of issue of this document, which are subject to change without notice. Customers are responsible for making their own independent assessment of the information in this document and any use of Azure’s products or services, each of which is provided “as is” without warranty of any kind, whether expressed or implied. This document does not create any warranties, representations, contractual commitments, conditions, or assurances from Azure, its affiliates, suppliers, or licensors. The responsibilities and liabilities of Azure to its customers are controlled by Azure agreements, and this document is not part of, nor does it modify, any agreement between Azure and its customers.</p>

<h3 id="legal-notices">Legal Notices</h3>

<p>Microsoft and any contributors grant you a license to the Microsoft documentation and other content in this repository under the <a href="https://creativecommons.org/licenses/by/4.0/legalcode">Creative Commons Attribution 4.0 International Public License</a>, see the <a href="LICENSE">LICENSE</a> file, and grant you a license to any code in the repository under the <a href="https://opensource.org/licenses/MIT">MIT License</a>, see the <a href="LICENSE-CODE">LICENSE-CODE</a> file.</p>

<p>Microsoft, Windows, Microsoft Azure and/or other Microsoft products and services referenced in the documentation may be either trademarks or registered trademarks of Microsoft in the United States and/or other countries. The licenses for this project do not grant you rights to use any Microsoft names, logos, or trademarks. Microsoft’s general trademark guidelines can be found at <a href="http://go.microsoft.com/fwlink/?LinkID=254653">http://go.microsoft.com/fwlink/?LinkID=254653</a>.</p>

<p><br /></p>

<h2 id="privacy">Privacy</h2>

<p>Privacy information can be found at <a href="https://privacy.microsoft.com/en-us/">https://privacy.microsoft.com/en-us/</a></p>

<p>Microsoft and any contributors reserve all others rights, whether under their respective copyrights, patents, or trademarks, whether by implication, estoppel or otherwise.</p>

<p><br /></p>


</div>




<script type="application/javascript">
  const PATH = window.location.pathname.replace(/\/+$/, '');
  const THIS_VERSION = PATH.substring(PATH.lastIndexOf('/') + 1);
  fetch('../versions.json')
    .then(function(response) {
        if (response.status == 200) {
          response.json().then(function(versions) {
            var select = '<select onchange="if (this.value) window.location.href=this.value">';
            versions.forEach(function(v){
                select += '<option value="../'+v.version+'"';
                if (v.version == THIS_VERSION) select += ' selected';
                select += '>'+v.version;
                if (v.latest) select += ' (★ Latest)';
                select += '</option>';
            });
            select += '</select>';
            document.querySelectorAll('.version-nav').forEach(function(nav) {
              nav.innerHTML = select;
            });
          });
        } else {
          console.log('ERROR', response);
        }
      }
    ).catch(function(err) {
      console.log('Error', err);
    });
</script>

    </main>

    <!-- Optional footer content -->

  </body>
</html>
